---
title: Java中的锁
date: 2020-03-24 14:55:42
tags:
 - java
 - 多线程
 - asyn/syn
 - JUC
categories: Java多线程

---

有锁编程主要是保证不同线程对同一资源写操作的可见性，以防止不同线程读取到的内存状态不一致导致的不可预期结果。而Java中的有锁编程可以通过volatile，synchronized以及各种Lock类实现。那么，为了更好的理解并发读写的一致性，就不得不探究一下这些机制的实现和区别了。

<!-- more -->

## 1. Synchronized， Volatile和Lock的区别

### 1.1 Volatile

volatile 是Java自带关键字，可以保证被修饰变量的**单次读写**是可见的。类似于i++这样的复合操作是没法保证操作的同步。Volatile是相较于Sychronized和Lock而言要更加的轻量级，无线程切换开销，但缺点是只能修饰单个变量。

### 1.2 Sychronized

Sychronized是通过锁实现同步的，而Java中的每个对象都可以作为一个锁。Sychronize可以修饰方法，代码块。当程序运行时，单个线程执行同步代码之前必须要获取到锁，代码执行结束或者抛出异常之后必须要释放锁。这个过程程序要不用关心。

### 1.3 Lock

Java中的Lock其实就是一个个提供了lock()和unlock()方法的类。而针对不同的场景，也有很多不同设计的锁可以选择。  

#### 1.3.1 公平锁/非公平锁

对于互斥资源而言，在某个时刻只能由一个线程获取，而其他线程会进入等待状态。公平与非公平是相对于等待的线程而言。一般情况下，我们认为等待时间很长的话，公平一点就让我早点获取到锁，类似于FIFO，这种锁称之为公平锁；而不顾等待锁的时长，任何线程任何时刻竞争锁都有可能成功，这种能够插队的情况就是非公平锁。公平锁对于有优先级的线程而言，不太友好，优先级高但是等待时间较短的线程无法很快获取到资源。而非公平锁则有可能导致线程无法获取到锁，饿死。 

#### 1.3.2 乐观锁/悲观锁  

按照是都对资源加锁，可以将所分为悲观锁和乐观锁。悲观锁和乐观锁是两种对立的锁思想，而不是指具体的两种锁。  

悲观锁悲观地认为所有拿到线程的资源都会对资源进行操作，所以为了保证同步，需要对资源加锁。线程在持有资源的时候会对资源加锁，这样其他线程只能都能等到锁释放后，竞争获取到锁才能访问资源。这样可以保证操作的原子性和数据的可见性。Java中的Synchronized和ReentrantLock等独占锁都是悲观锁。

而乐观锁与之相反，它乐观地认为大家拿到资源都不会对数据进行更新，所以访问资源的时候不需要加锁。但是它在写数据的时候需要判断数据是否进行了更改。乐观锁是一种无锁编程的思想，一般通过CAS实现，可以保证数据操作的可见性。缺点是CAS自旋会占用较多的CPU资源，而且CAS无法避免ABA问题。

以上，悲观锁多用于写操作多于读操作的场景，而乐观锁则相反。  

#### 1.3.3 独占锁/共享锁

独占锁又称之为排他锁。顾名思义，这种锁在某个时刻只能由一个线程获取，而其他的线程在锁被占有的情况下，只能等待。Java中的Synchronized和大多数Lock都是独占锁。  

共享锁是指锁能够被多个线程所拥有。如果线程对某个资源加上了共享锁之后，其他线程则只能在这个资源上加共享锁，而不能加独占锁。或的共享锁的线程只能读取数据，不能更改数据。

读写锁中的读锁就是共享锁，而写锁则为独占锁。  

#### 1.3.4 自旋锁/互斥锁  

在多核CPU中可能有多个线程同时执行，但是对于某些锁而言，在某个时刻只能由一个线程拥有。那么，没有获取到锁的线程该做些什么呢？1.如果线程一直循环尝试获取锁的话，这种锁称之为自旋锁；2.如果将没有获取到锁的线程阻塞起来，等待唤起，这种锁成为互斥锁。

#### 1.3.5  重入锁/不可重入锁

当一个线程获取到锁之后未释放的情况下可以再次获取该锁的锁成为可重入锁。可重入锁能够在一定程度上避免死锁的情况。如下代码，如果锁不可重入，就会在执行B方法的lock.lock()时死锁：

```java
public void A(){
    lock.lock();
    try {
        B();
    } finally {
        lock.unlock();
    }
}

public void B() {
    lock.lock();
    try {
        //do something
    } finally {
        lock.unlock();
    }
}
```







